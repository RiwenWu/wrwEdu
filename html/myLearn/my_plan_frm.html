<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <style type="text/css">

    </style>
</head>

<body>
  <section>
    <div class="aui-tab" id="tab">
        <div class="aui-tab-item aui-active" tapmode onclick="chengeData(this)">线下课程</div>
        <div class="aui-tab-item" tapmode onclick="chengeData(this)">线上课程</div>
    </div>
  </section>
    <div class="aui-content aui-margin-b-15">

        <div class="aui-card-list">
            <div class="aui-card-list-content">
                <ul class="aui-list aui-media-list">
                  <!--
                    <li class="aui-list-item aui-list-item-middle" tapmode onclick="showOfflineCourse(2)">
                        <div class="aui-media-list-item-inner">
                            <div class="aui-list-item-media">
                                <img src="../../image/demo5.png" class="aui-img-round aui-list-img-sm">
                            </div>
                            <div class="aui-list-item-inner aui-list-item-arrow">
                                <div class="aui-list-item-text">
                                    <div class="aui-list-item-title aui-font-size-14">课程名称</div>
                                </div>
                                <div class="aui-list-item-text">
                                    主题
                                </div>
                                <div class="aui-info">
                                    还有XX天开始/结束
                                    <div class="aui-pull-right">
                                      <i class="aui-iconfont aui-icon-trash" tapmode onclick="delOfflineCourse()"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="aui-list-item aui-list-item-middle" tapmode onclick="showOfflineCourse(3)">
                        <div class="aui-media-list-item-inner">
                            <div class="aui-list-item-media">
                                <img src="../../image/demo5.png" class="aui-img-round aui-list-img-sm">
                            </div>
                            <div class="aui-list-item-inner aui-list-item-arrow">
                                <div class="aui-list-item-text">
                                    <div class="aui-list-item-title aui-font-size-14">课程名称</div>
                                </div>
                                <div class="aui-list-item-text">
                                    主题
                                </div>
                                <div class="aui-info">
                                    还有XX天开始/结束
                                    <div class="aui-pull-right">
                                      <i class="aui-iconfont aui-icon-trash" tapmode onclick="delOfflineCourse()"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                  -->
                </ul>
            </div>
        </div>

    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    apiready = function() {
        api.parseTapmode();
        initData();
    }

    function chengeData(obj){
      var items = $api.domAll('.aui-tab-item');
      for(var i = 0 ; i < items.length ; i++){
        if($api.hasCls(items[i], 'aui-active')){
          $api.removeCls(items[i], 'aui-active');
        }
      }
      $api.addCls(obj,'aui-active');

    }

    function showOfflineCourse(id){
      api.openFrame({
            name: 'offlineCourseDialog',
            url: './offlineCourseDialog.html',
            pageParam: {
                id: id
            },
            rect: {
              x:0,
              y:0,
              w:api.winWidth,
              h:api.winHeight
            },
            bgColor: 'rgba(0,0,0,0.6)',
        bounces: false
      });
    }

    //取消计划
    function delOfflineCourse(id, state) {
      //阻止事件冒泡
      event.preventDefault();
      event.stopPropagation();

      api.confirm({
          title: '提示',
          msg: '确定要取消计划',
          buttons: ['确定', '取消']
      }, function(ret, err) {
          if(ret.buttonIndex == 1){
              api.ajax({
                  url: 'http://172.16.169.9:8081/eduonline-app/changeUserOfflineCourseStateById.json',
                  method: 'post',
                  data: {
                      values: {
                          userOfflinecourseId: id,
                          state: state
                      }
                  }
              },function(ret, err){
                  if (ret.bool) {
                    api.toast({
                      msg: '取消成功',
                      duration: 2000,
                      location: 'middle'
                    });
                    initData();
                  } else {
                      alert( JSON.stringify( ret ) );
                  }
              });
          }

      });
    }

    //初始化界面
    function initData(){
        var userId = $api.getStorage("userId");
        api.ajax({
            url: 'http://172.16.169.9:8081/eduonline-app/queryOfflineCourseList.json',
            method: 'post',
            data: {
                values: {
                    userId: userId
                }
            }
        },function(ret, err){
            if (ret.bool) {
                var html = '';
                var showDate = '';
                for(var i = 0 ; i < ret.data.length ; i++){
                    if(ret.data[i].distanceBegins != undefined){
                        showDate = "距离线下课程开始还有" + ret.data[i].distanceBegins + "天";
                    } else if(ret.data[i].distanceEnd != undefined){
                        showDate = "距离线下课程结束还有" + ret.data[i].distanceBegins + "天";
                    }
                    html += '<li class="aui-list-item aui-list-item-middle" tapmode onclick="showOfflineCourse('+ ret.data[i].offlinecourseId +')">'
                                +'<div class="aui-media-list-item-inner">'
                                    +'<div class="aui-list-item-media">'
                                        +'<img src="http://172.16.169.9:8081/eduonline-web/'+ ret.data[i].coverPic +'" class="aui-img-round aui-list-img-sm">'
                                    +'</div>'
                                    +'<div class="aui-list-item-inner aui-list-item-arrow">'
                                        +'<div class="aui-list-item-text">'
                                            +'<div class="aui-list-item-title aui-font-size-14">'+ ret.data[i].courseName +'</div>'
                                        +'</div>'
                                        +'<div class="aui-list-item-text">'
                                            + ret.data[i].offlinecourseTitle
                                        +'</div>'
                                        +'<div class="aui-info">'
                                            + showDate
                                            +'<div class="aui-pull-right">'
                                              +'<i class="aui-iconfont aui-icon-trash" tapmode onclick="delOfflineCourse('+ ret.data[i].id +', 1)"></i>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                +'</div>'
                            +'</li>';
                    showDate = '';
                }
                $api.html($api.dom('.aui-list'), html);
            } else {
                alert( JSON.stringify( ret ) );
            }
        });

    }
</script>

</html>
